#!/usr/bin/env bash
set -e

# â”€â”€â”€ Colors & Logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
log()   { echo -e "\033[1;32m[INFO]\033[0m $(pretty_path "$1")"; }
warn()  { echo -e "\033[1;33m[WARN]\033[0m $(pretty_path "$1")"; }
error() { echo -e "\033[1;31m[ERROR]\033[0m $(pretty_path "$1")"; }

echo_cmd() { echo -e "\033[1;32mâ”€â”€â”€\033[0m $(pretty_path "$1")"; }
log_cmd()  { echo -e "\033[1;32mâ”€â”€â”€>\033[0m $(pretty_path "$1")"; }
run_cmd() {
    # Build a pretty display of the command, replacing $HOME with ~
    local display_cmd=()
    for arg in "$@"; do
        display_cmd+=("$(pretty_path "$arg")")
    done

    echo -e "\033[1;34m>>> ${display_cmd[*]}\033[0m"
    "$@"
}

header()   { echo -e "\n\033[1;35mâ”€â”€â”€ $1 â”€â”€â”€\033[0m\n"; }

pretty_path() {
    local path="$1"
    # Absolute path starting with $HOME â†’ replace with ~
    if [[ "$path" == "$HOME"* ]]; then
        echo "~${path#$HOME}"
    else
        echo "$path"
    fi
}


# â”€â”€â”€ Continue with your existing vars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
source ./scripts/lib/environment-variables.sh
source ./scripts/lib/functions.sh
source ./scripts/lib/dist-determine.sh

# â”€â”€â”€ Detect Shell & Distro â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
USER_SHELL=$(basename "$SHELL")

#if [ "$(command -v python3)" ]; then
#    DISTRO=$(python3 "$PYTHON_DIR/detect_os.py")
#else 
#    DISTRO=$($SCRIPTS_DIR/detect_os.bash)
#fi
DISTRO=$OS_GROUP_ID


# â”€â”€â”€ Safe Read Wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#safe_read() {
#    local prompt="$1" varname="$2"
#    if [[ -t 0 ]]; then
#        x read -rp "$prompt" "$varname"
#    elif [[ -e /dev/tty ]]; then
#        x read -rp "$prompt" "$varname" </dev/tty
#    else
#        log "Non-interactive environment â€” defaulting to yes."
#        eval "$varname='y'"
#    fi
#}

# â”€â”€â”€ Run Scripts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#run_script() {
#    local script_name="$1"
#    local script_path="$SCRIPTS_DIR/$script_name"
#
#    if [[ ! -f "$script_path" ]]; then
#        warn "$script_name not found, skipping."
#        return
#    fi
#
#    if $AUTO_MODE; then
#        log_cmd "Running $script_name..."
#        source "$script_path"
#    else
#        local choice
#        safe_read "Run $script_name? [Y/n] " choice
#        case "$choice" in
#            [nN]*) log_cmd "Skipping $script_name" ;;
#            *) log_cmd "Running $script_name..."; source "$script_path" ;;
#        esac
#    fi
#    echo
#}

# â”€â”€â”€ Menu (Manual Mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
show_menu() {
    header "Nixie's Multi-Distro Bootstrap"
    log_cmd "Detected distro: $DISTRO"
    log_cmd "Detected shell: $USER_SHELL"


    options=(
        "Update System Packages"
        "Install Packages"
        "Symlink Configs"
        "Setup Shell"
        "Install Flatpaks"
        "Exit"
    )

    scripts=(
        "update_system.sh"
        "install_pkgs.sh"
        "symlink.sh"
        "setup_shell.sh"
        "install_flatpak.sh"
    )

    while true; do
        for i in "${!options[@]}"; do
            echo -e "\033[1;32m$((i+1)).\033[0m ${options[$i]}"
        done

        read -rp $'\nChoose what to run (or q to quit): ' choice
        case "$choice" in
            1) v "${scripts[0]}" ;;
            2) v "${scripts[1]}" ;;
            3) v "${scripts[2]}" ;;
            4) v "${scripts[3]}" ;;
            5) v "${scripts[4]}" ;;
            6|q|Q) echo_cmd "Goodbye!"; break ;;
            *) warn "Invalid choice." ;;
        esac
        echo
    done
}

# â”€â”€â”€ Auto Mode Execution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if $AUTO_MODE; then

    header "Nixie's Multi-Distro Bootstrap"
    log_cmd "Detected distro: $DISTRO"
    log_cmd "Detected shell: $USER_SHELL"

    if ! $SKIP_UPDATE; then
        echo_cmd "Running system update..."
        x "update_system.sh"
    else
        x "Skipping system update as requested."
    fi

    for script in "install_pkgs.sh" "stow_configs.sh" "setup_shell.sh" "install_flatpak.sh"; do
        x "$script"
    done

    echo_cmd "Bootstrap complete. Enjoy your setup ðŸŽ‰"
else
    # showfun show_menu
    v show_menu
fi
